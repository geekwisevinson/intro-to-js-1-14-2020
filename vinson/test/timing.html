<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" href="codemirror/lib/codemirror.css">
    <script src="codemirror/lib/codemirror.js"></script>

    <style>
        .containers4 {
            display: flex;

        }

        .containers4 > * {
            display: flex;
            flex: 1;
            margin: 10px;
            height: 45vh;
        }
    </style>


    <script src="codemirror/addon/edit/closetag.js"></script>

    <script src="codemirror/mode/xml/xml.js"></script>
    <script src="codemirror/mode/javascript/javascript.js"></script>
    <script src="codemirror/mode/htmlmixed/htmlmixed.js"></script>

    <link rel="stylesheet" href="codemirror/theme/dracula.css">
</head>
<body>
<div class="containers4">
    <textarea name="" id="htmlEditor1"></textarea>
    <textarea name="" id="htmlEditor2"></textarea>
</div>
<div class="containers4">
    <div class="result1">
        result 1
    </div>
    <div class="result2">
        result 2
    </div>
</div>
<script>
    const htmlEditor1 = CodeMirror.fromTextArea(
        document.querySelector('#htmlEditor1'), {
            mode: 'htmlmixed',
            selectionPointer: true,
            lineNumbers: true,
            autoCloseTags: true,
            theme: 'dracula',
        });


    const htmlEditor2 = CodeMirror.fromTextArea(document.querySelector('#htmlEditor2'), {
        mode: 'htmlmixed',
        selectionPointer: true,
        lineNumbers: true,
        autoCloseTags: true,
        theme: 'dracula',
    });

    class TimeMaster {
        startLoop = new Date();
        lastLoop = new Date();
        currentLoop = new Date();
        actions = {};
        fps = 1000;
        intervalTime = 100;
        step = 0;
        el = null;
        intervalID = null;
        data = {};

        constructor(props) {
            this.setIntervalTime((props && props.fps) ? props.fps : 1);
        }

        updateData(prop, value) {
            this.data[prop] = value;
        }

        start() {
            this.startLoop = new Date();
            this.intervalID = setInterval(() => {
                this.step += 1;
                this.updateTime();
                this.checkTime();
                this.getFps();
                this.doActions(this.step);
                this.updateHTML({html: this.myHTML()})
            }, this.intervalTime);
            console.log(this.intervalTime, '********')
        }

        myHTML() {
            console.log('myHTML')
        }

        end() {
            clearInterval(this.intervalID);
        }

        updateTime() {
            return this.currentLoop = new Date();
        }

        checkTime() {
            return this.getTimeSinceStart();
        }

        getFps() {
            this.currentLoop = new Date();
            this.fps = 1000 / (this.currentLoop - this.lastLoop);
            this.lastLoop = this.currentLoop;
            return this.fps;
        }

        getTimeSinceStart() {
            return (this.currentLoop - this.startLoop) / 1000;
        }

        setIntervalTime(fps) {
            this.intervalTime = 1000 / fps;
            return this.intervalTime;
        }

        setAction(step, actions) {
            if (!this.actions[step]) {
                this.actions[step] = [];
            }
            this.actions[step].push(actions);
        }

        doActions(step) {
            if (this.actions[step]) {
                console.log('Action Step', step);
                this.actions[step].forEach((action) => this.doAction(action))
            } else {
            }
        }

        doAction(action) {
            console.log(action[0].name);
            action[0](action[1]);
        }

        createEl(config) {
            this.removeEl();
            this.el = document.createElement(config.type);
            this.el.controller = this;
        }

        log() {
            delete this.el.controller;
            console.log(this);
            this.el.controller = this;
        }

        removeEl() {
            if (this.el) {
                this.el['remove']();
            }
            this.el = null;
        }

        append(config) {
            config.parent['appendChild'](this.el);
        }

        prepend(config) {
            config.parent['prepend'](this.el);
        }

        updateHTML(config) {
            if (this.el) {
                this.el['innerHTML'] = config['html'];
            } else {
                console.log('no el', this.el, config);
            }
        }

        updateStyle(config) {
            for (let prop in config) {
                if (config.hasOwnProperty(prop)) {
                    this.el['style'][prop] = config[prop];
                }
            }
        }

        replace(config) {
            if (this.el) {
                const newNode = document.createElement(config.type);
                this.el['parentNode'].insertBefore(newNode, this.el['nextSibling']);
                this.el['remove']();
                this.el = newNode;
            }
        }

        doTil(actionFunc, conditionFunc, finishedFunc) {
            const doTilId = setInterval(() => {
                if (conditionFunc()) {
                    actionFunc();
                } else {
                    if (finishedFunc) {
                        finishedFunc();
                    }
                    clearInterval(doTilId);
                }
            }, this.intervalTime);
        }
    }

    // function createHeader() {
    //     const timeMaster = new TimeMaster();
    //     timeMaster.myHTML = stepperHTML;
    //     timeMaster.setAction(1, [timeMaster.createEl.bind(timeMaster), {type: 'h1'}]);
    //     timeMaster.setAction(2, [timeMaster.append.bind(timeMaster), {parent: document.body}]);
    //     timeMaster.setAction(3, [timeMaster.updateHTML.bind(timeMaster), {html: 'HELLO'}]);
    //     timeMaster.setAction(4, [timeMaster.updateStyle.bind(timeMaster), {color: 'yellow'}]);
    //     timeMaster.setAction(4, [timeMaster.updateStyle.bind(timeMaster), {position: 'absolute'}]);
    //     timeMaster.setAction(5, [timeMaster.updateStyle.bind(timeMaster), {top: '30px'}]);
    //     timeMaster.setAction(6, [timeMaster.updateStyle.bind(timeMaster), {left: '30px'}]);
    //     timeMaster.setAction(100, [timeMaster.end.bind(timeMaster)]);
    //
    //     timeMaster.start();
    // }
    // function createParagraph() {
    //     const timeMaster = new TimeMaster();
    //     timeMaster.myHTML = stepperHTML;
    //     timeMaster.setAction(1, [timeMaster.createEl.bind(timeMaster), {type: 'p'}]);
    //     timeMaster.setAction(2, [timeMaster.append.bind(timeMaster), {parent: document.body}]);
    //     timeMaster.setAction(3, [timeMaster.updateHTML.bind(timeMaster), {html: 'This is a paragraph!'}]);
    //     timeMaster.setAction(4, [timeMaster.updateStyle.bind(timeMaster), {color: 'red'}]);
    //     timeMaster.setAction(4, [timeMaster.updateStyle.bind(timeMaster), {position: 'absolute'}]);
    //     timeMaster.setAction(6, [timeMaster.updateStyle.bind(timeMaster), {top: '300px'}]);
    //     timeMaster.setAction(100, [timeMaster.end.bind(timeMaster)]);
    //     timeMaster.start();
    // }

    function createStepperKeeper() {
        const timeMaster = new TimeMaster();
        timeMaster.myHTML = stepperHTML;
        timeMaster.setAction(1, [timeMaster.createEl.bind(timeMaster), {type: 'p'}]);
        timeMaster.setAction(1, [timeMaster.append.bind(timeMaster), {parent: document.body}]);
        timeMaster.setAction(1, [timeMaster.updateStyle.bind(timeMaster), stepperStyles()]);
        timeMaster.start();
    }

    // createStepperKeeper();

    function createPlayer() {
        const timeMaster = new TimeMaster();
        timeMaster.myHTML = htmlPlayer;
        timeMaster.updateData('health', 100);
        timeMaster.updateData('attack', 10);
        timeMaster.updateData('attackType', 'Fire');
        timeMaster.setAction(1, [timeMaster.createEl.bind(timeMaster), {type: 'p'}]);
        timeMaster.setAction(1, [timeMaster.append.bind(timeMaster), {parent: document.body}]);
        timeMaster.setAction(1, [timeMaster.updateStyle.bind(timeMaster), stepperStyles()]);
        timeMaster.start();
        return timeMaster;
    }

    // const player1 = createPlayer();

    function stepperHTML() {
        return `
<div>
     <div><span>Stepper: </span><span>${this.step}</span></div>
</div>
        `
    }

    function stepperStyles() {
        return {
            color: 'red',
            fontSize: '40px',
            // position: 'absolute',
            // top: '10px',
            opacity: .3
        };
    }

    function htmlPlayer() {
        return `
<div style="border: 1px solid black">
     <div><span>Health: </span><span>${this.data['health']}</span></div>
      <div><span>Attack: </span><span>${this.data['attack']}</span></div>
            <div><span>Attack Type: </span><span>${this.data['attackType']}</span></div>
</div>
        `;
    }

    function insertTextAtCursor(editor, text, start) {
        const doc = editor.getDoc();
        const cursor = doc.getCursor();
        doc.replaceRange(text, {
            line: start ? start.line : 0,
            ch: start ? start.ch : 0,
            sticky: null
        }, {
            line: cursor.line,
            ch: cursor.position,
            sticky: null
        });
    }

    // const testString = htmlSetup();
    // const textApp = new TimeMaster({fps: 30});
    // let i = 0;
    // textApp.doTil(function () {
    //     console.log('test');
    //     i++;
    //     const htmlValue = htmlEditor1.getValue();
    //     document.querySelector('.result1').innerHTML = htmlValue;
    //     insertTextAtCursor(htmlEditor1, testString.slice(0, i));
    // }, function () {
    //     return (testString.slice(0, i) !== testString);
    // }, function () {
    //     console.log('finished');
    //     setTimeout(function () {
    //         i = 0;
    //         const testStart = {line: 7, ch: 0};
    //         htmlEditor1.setCursor(testStart);
    //         textApp.doTil(function () {
    //             document.querySelector('.result1').innerHTML = htmlEditor1.getValue();
    //             i++;
    //             insertTextAtCursor(htmlEditor1, textJS().slice(0, i), testStart);
    //             const htmlValue = htmlEditor1.getValue();
    //             const scriptValue = getBetweenScripts(htmlValue);
    //             try {
    //                 eval(scriptValue);
    //             }
    //             catch (e) {
    //                 console.log('error');
    //             }
    //         }, function () {
    //             return (textJS().slice(0, i) !== textJS());
    //         }, function () {
    //             console.log('finished')
    //         });
    //     }, 0);
    // });


    function htmlSetup() {
        return `<!DOCTYPE html>
<html>
    <head>
    </head>
    <body>
    <h1 class="test">test</h1>
        <${'script'}>

        <${'/script'}>
    </body>
</html>`.trim();
    }

    function textJS() {
        return `            const test = 'missing';
            const test2 = 3333333;
            const apple = 'mac';
            console.log(test2);
            document.querySelectorAll('.test')[0].innerHTML = 'what' + apple;
            `;
    }


    function getBetweenScripts(text) {
        const tagName = 'script';
        const startTag =  `<${tagName}>`;
        const closeTag = `</${tagName}>`;
        if (text.includes(startTag) && text.includes(closeTag)) {
            return text.slice(text.indexOf(startTag) + startTag.length + 1, text.indexOf(closeTag)).trim();
        } else {
            return '';
        }
    }

    function makeEditor(editor, result, textHtml, textJS, jsStart) {
        if (editor.allSet !== true) {
            console.log('add listen');
            editor.on("change", function(cm, change) { onChangeUpdate(editor, result)});
        }
        editor.allSet = true;
        editor.setValue('');

        const textApp = new TimeMaster({fps: 30});
        let i = 0;
        textApp.doTil(function () {
            i++;
            insertTextAtCursor(editor, textHtml.slice(0, i));
        }, function () {
            return (textHtml.slice(0, i) !== textHtml);
        }, function () {
            console.log('finished');
            setTimeout(function () {
                i = 0;
                editor.setCursor(jsStart);
                textApp.doTil(function () {
                    i++;
                    insertTextAtCursor(editor, textJS.slice(0, i), jsStart);
                }, function () {
                    return (textJS.slice(0, i) !== textJS);
                }, function () {
                    console.log('finished')
                });
            }, 0);
        });
    }

    makeEditor(htmlEditor1, '.result1', htmlSetup(), textJS(), {line: 7, ch: 0, sticky: null});
    makeEditor(htmlEditor2, '.result2', htmlSetup(), textJS(), {line: 7, ch: 0, sticky: null});


    function onChangeUpdate(editor, result) {
        document.querySelector(result).innerHTML = editor.getValue();
        const htmlValue = editor.getValue();
        let scriptValue = getBetweenScripts(htmlValue);
        scriptValue = scriptValue.replace(/querySelector\('/g, `querySelector('${result} `);
        scriptValue = scriptValue.replace(/querySelector\("/g, `querySelector("${result} `);
        scriptValue = scriptValue.replace(/querySelectorAll\('/g, `querySelectorAll('${result} `);
        scriptValue =scriptValue.replace(/querySelectorAll\("/g, `querySelectorAll("${result} `);
        try {
            eval(scriptValue);
        }
        catch (e) {
            console.log('error');
        }
    }
</script>

</body>
</html>
